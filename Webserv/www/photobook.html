<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Evaluator Photobook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="/styles/photobook.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        referrerpolicy="no-referrer">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet" />
</head>

<body class="text-dark fw-light">
    <nav class="navbar sticky-top">
        <div class="px-5 pt-4">
            <a href="/index.html#features" class="back-button text-muted">
                <i class="fa-solid fa-angle-left"></i>
                Back to features
            </a>
        </div>
    </nav>
    <div class="container py-5">
        <h2 class="h1 text-center">About the Photobook</h2>
        <p class="text-center text-muted py-2">
            A simple photobook app that loads images from the server‚Äôs <code>upload/</code> folder, lets you add new
            photos, name them, and delete them. </br>Changes persist on the server and are rendered dynamically on the
            browser. How requests work when interacting
            with this
            simple app:
        </p>
        <div class="row row-cols-1 row-cols-lg-3 g-3 align-items-stretch">
            <div class="col">
                <div class="p-3 border border-primary rounded p-3 h-100 request_card get">
                    <h4 class="h6 m-0 fw-normal">GET: load photos</h4>
                    <p class="text-muted mb-2 fs-6 fw-light">
                        Before the gallery renders, the app sends a <strong>GET</strong> request to fetch the file
                        list
                        from
                        <code>upload/</code>.</br>
                        The response populates the grid.
                    </p>
                </div>
            </div>
            <div class="col ">
                <div class="p-3 border border-success rounded p-3 h-100 fw-light request_card post">
                    <h4 class="h6 m-0">POST: add a photo</h4>
                    <p class="text-muted mb-2 fs-6">
                        Click the <span class="badge text-bg-secondary">+</span> button to open the upload dialog.
                        Choose a file and
                        enter a
                        name.
                        If you leave the name empty, the server assigns a generic name with a timestamp.
                        Files larger than <strong>1&nbsp;MB</strong> are rejected.
                    </p>
                </div>
            </div>
            <div class="col">
                <div class="p-3  border border-danger rounded p-3 fw-light h-100 request_card delete">
                    <h4 class="h6 m-0">DELETE: remove a photo</h4>
                    <p class="text-muted mb-2 fs-6">
                        Click the <span class="badge text-bg-secondary">‚úï</span> on a photo to send a
                        <strong>DELETE</strong> request for that
                        file.</br>
                        If all photos are deleted, an alert appears at the bottom of the page stating the Photobook
                        is
                        empty.
                    </p>
                </div>
            </div>
        </div>
        <p class="text-start my-2 text-muted">
            Tip: Press <kbd>F12</kbd> ‚Üí <strong>Console</strong> to watch requests and responses as you interact.
        </p>

        <div class="container my-5">
            <div class="photo-grid mb-4">
                <!-- Upload Button -->
                <div class="photo-card" onclick="showModal()">
                    <span class="upload-icon">+</span>
                </div>
            </div>
            <!-- Empty state message -->
            <p id="emptyMessage"
                class="text-center mt-4 d-none px-4 py-3 border rounded bg-warning bg-opacity-25 text-dark">
                üì≠ The photobook is empty! Add its first picture!
            </p>

            <!-- Upload Modal -->
            <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="photoUploadForm" enctype="multipart/form-data">
                            <div class="modal-header">
                                <h5 class="modal-title" id="uploadModalLabel">
                                    Add your photo
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Click the button below to add your photo.</p>
                                <input type="file" name="file" id="modalFileInput" class="form-control mb-3" required />
                                <div id="fileReady" class="text-success d-none">
                                    ‚úÖ Photo ready to upload
                                </div>

                                <label for="photoName" class="form-label mt-3">Photo name</label>
                                <input type="text" name="name" id="photoName" class="form-control" required />
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">
                                    Upload
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Confirm Deletion</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete this photo?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancel
                        </button>
                        <button id="confirmDeleteBtn" type="button" class="btn btn-danger">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deletion Toast -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="deleteToast" class="toast text-white bg-success border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ‚úÖ Photo deleted successfully from database.
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showModal() {
            const modal = new bootstrap.Modal(
                document.getElementById("uploadModal")
            );
            modal.show();
        }

        document.getElementById("modalFileInput").addEventListener("change", function () {
            const file = this.files[0];
            const readyNotice = document.getElementById("fileReady");
            const nameInput = document.getElementById("photoName");

            if (!file) {
                readyNotice.classList.add("d-none");
                nameInput.value = "";
                return;
            }

            const allowedTypes = ["image/jpeg", "image/png", "image/webp", "image/gif"];
            if (!allowedTypes.includes(file.type)) {
                alert("‚ùå Only JPG, PNG, WEBP, and GIF files are allowed.");
                this.value = "";
                readyNotice.classList.add("d-none");
                nameInput.value = "";
                return;
            }

            readyNotice.classList.remove("d-none");

            // sets value to filename without extension
            var baseName = file.name.replace(/\.[^/.]+$/, "");
            nameInput.value = baseName || "";
        });


        //POST REQUEST
        document
            .getElementById("photoUploadForm")
            .addEventListener("submit", function (e) {
                e.preventDefault();

                const form = e.target;
                const formData = new FormData(form);

                fetch("/upload", {               // your C++ upload route
                    method: "POST",
                    headers: {
                        "X-Frontend": "1",              // tell server to respond JSON
                        "Accept": "application/json"
                    },
                    body: formData
                })
                    .then((res) => {
                        if (!res.ok) throw new Error("Post request failed: " + res.status);
                        console.log(res.json);
                        return res.json();              // server returns { ok:true, path:"..." }
                    })
                    .then((data) => {
                        console.log("‚úÖ Post request successful, uploaded the following file: " + data.path)
                        alert("‚úÖ Upload successful: " + data.path);
                        form.reset();
                        document.getElementById("fileReady").classList.add("d-none");
                        bootstrap.Modal.getInstance(
                            document.getElementById("uploadModal")
                        ).hide();
                        location.reload();              // or append dynamically to gallery
                    })
                    .catch((err) => {
                        console.error("‚ùå Upload error:", err);
                        alert("Upload failed!");
                    });
            });


        //GET REQUEST
        console.time("‚è∞ Completed in");
        fetch("../cgi-bin/photobook_json.py")
            .then((res) => {
                if (!res.ok) throw new Error("HTTP error " + res.status);
                return res.json();
            })
            .then((data) => {
                // makes the "empty photobooth" warning visible or not
                if (!Array.isArray(data) || data.length === 0) {
                    document
                        .getElementById("emptyMessage")
                        .classList.remove("d-none");
                    return;
                } else {
                    document
                        .getElementById("emptyMessage")
                        .classList.add("d-none");
                }

                console.log("‚úÖ Get request handled successfully!");
                console.timeEnd("‚è∞ Get request completed in");
                console.log("Retrieved data from Get request:", data);

                const grid = document.querySelector(".photo-grid");
                let fileToDelete = null;
                let cardToDelete = null;
                document.getElementById("confirmDeleteBtn").onclick =
                    () => {
                        if (!fileToDelete || !cardToDelete) return;

                        fetch(`/upload/${fileToDelete}`, {
                            method: "DELETE",
                        })
                            .then((res) => {
                                if (!res.ok)
                                    throw new Error("Delete failed");

                                cardToDelete.remove();

                                const toast = new bootstrap.Toast(
                                    document.getElementById("deleteToast")
                                );
                                toast.show();

                                fileToDelete = null;
                                cardToDelete = null;

                                bootstrap.Modal.getInstance(
                                    document.getElementById(
                                        "confirmDeleteModal"
                                    )
                                ).hide();

                                // shows "empty photobook" message
                                if (
                                    document.querySelectorAll(".photo-card")
                                        .length === 1
                                ) {
                                    // Only the upload button shows if empty
                                    document
                                        .getElementById("emptyMessage")
                                        .classList.remove("d-none");
                                }
                            })
                            .catch((err) => {
                                console.error(
                                    "‚ùå Could not delete image:",
                                    err
                                );
                                alert("Error: failed to delete image.");
                            });
                    };

                data.forEach((filename) => {
                    const card = document.createElement("div");
                    card.className = "photo-card";

                    // Creates the spinner
                    const spinner = document.createElement("div");
                    spinner.className = "spinner-border text-secondary";
                    spinner.setAttribute("role", "status");
                    card.appendChild(spinner);

                    // Creates the image element
                    const img = document.createElement("img");
                    img.src = `/upload/${filename}`;
                    img.alt = filename;
                    img.style.display = "none"; // Hide until loaded
                    const loadDelay = 800; // ms

                    let finished = false;

                    function revealImage(success) {
                        if (finished) return;
                        finished = true;

                        setTimeout(() => {
                            spinner.remove();

                            if (success) {
                                img.style.display = "block";
                                img.classList.add("visible");
                            } else {
                                const errorText =
                                    document.createElement("div");
                                errorText.textContent = "‚ùå Failed to load";
                                errorText.style.fontSize = "0.9rem";
                                errorText.style.color = "#dc3545";
                                card.appendChild(errorText);
                            }
                        }, loadDelay);
                    }

                    img.onload = () => revealImage(true);
                    img.onerror = () => revealImage(false);
                    card.appendChild(img);
                    grid.appendChild(card);

                    // DELETE BUTTON AND REQUEST
                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "√ó";
                    deleteBtn.className = "delete-btn";
                    deleteBtn.title = "Delete photo";

                    // PHASE 1: When user clicks X button
                    deleteBtn.onclick = () => {
                        fileToDelete = filename;
                        cardToDelete = card;

                        const modal = new bootstrap.Modal(
                            document.getElementById("confirmDeleteModal")
                        );
                        modal.show();
                    };

                    card.appendChild(deleteBtn);
                });
            })
            .catch((err) => {
                console.log("‚ùå Fetch failed!");
                console.timeEnd("‚è∞ Completed in");
                console.error("Request returned:", err);
            });
    </script>
</body>

</html>